ｇ id="qrcode"></div>
</div>
<div id="searchHistory">
    <h4>検索履歴</h4>
    <ul id="historyList"></ul>
</div>
</div>
</div>

<script>
    const lightPastelColors = [
        '#FFD1DC', '#FFE4B5', '#E6E6FA', '#B5EAD7', '#FFB6C1',
        '#E0FFFF', '#F0E68C', '#D8BFD8', '#FFDAB9', '#E0F6FF',
        '#F0F8FF', '#FAEBD7', '#FFE4E1', '#D3D3D3', '#F5F5DC',
        '#FFEBCD', '#F5DEB3', '#FFFACD', '#E6E6FA', '#F0FFF0'
    ];
    const darkPastelColors = [
        '#4A2D3A', '#4A412A', '#3A3A4A', '#2D4A3A', '#4A2D2D',
        '#2D3A4A', '#4A3A2D', '#3A2D4A', '#2D3A3A', '#3A3A2D',
        '#4A3A4A', '#2D2D4A', '#3A2D3A', '#413A2D', '#412D3A',
        '#4A2D41', '#2D414A', '#413A4A', '#3A412D', '#412D3A'
    ];

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function applyRandomPastelColor() {
        const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        let pastelColors = isDarkMode ? [...darkPastelColors] : [...lightPastelColors];
        pastelColors = shuffleArray(pastelColors);
        const randomColor = pastelColors[0];
        document.documentElement.style.setProperty('--bg-color', randomColor);
        const lastUpdate = localStorage.getItem('lastUpdate');
        if (lastUpdate) {
            const hoursPassed = (Date.now() - lastUpdate) / (1000 * 60 * 60);
            const sepiaValue = Math.min(hoursPassed * 0.02, 0.3);
            document.documentElement.style.setProperty('--sepia-filter', `sepia(${sepiaValue})`);
        } else {
            localStorage.setItem('lastUpdate', Date.now());
        }
    }

    window.addEventListener('load', applyRandomPastelColor);

    const urlParams = new URLSearchParams(window.location.search);
    const postOnlyMode = urlParams.get('postonly') === 'yes';
    const postParam = urlParams.get('p');

    const input = document.getElementById('post-input');
    const postsList = document.getElementById('posts');
    const modal = document.getElementById('contextModal');
    const urlContent = document.getElementById('urlContent');
    const searchHistory = document.getElementById('searchHistory');
    const historyList = document.getElementById('historyList');
    const shareUrlElement = document.getElementById('shareUrl');
    const showUrlBtn = document.getElementById('showUrlBtn');
    const downloadCsvBtn = document.getElementById('downloadCsvBtn');
    const statsBtn = document.getElementById('statsBtn');
    const showHistoryBtn = document.getElementById('showHistoryBtn');
    const sendTodayPostsBtn = document.getElementById('sendTodayPostsBtn');
    const postCountElement = document.getElementById('post-count');

    let allPosts = [];
    let isPosting = false;
    let isSearchMode = false;
    let hideThumbnailPosts = false;



    // トークン取得
    function getTokenFromCookie() {
        const urlToken = urlParams.get('token');
        if (urlToken) return urlToken;
        const cookies = document.cookie.split(';').map(cookie => cookie.trim());
        const tokenCookie = cookies.find(cookie => cookie.startsWith('token='));
        return tokenCookie ? tokenCookie.split('=')[1] : '';
    }

    function getThumbnailUrl(pageUrl) {
        // GyazoのURLを直接画像URLに変換
        if (pageUrl.includes('gyazo.com/')) {
            const gyazoId = pageUrl.split('gyazo.com/')[1].split(/[/?#]/)[0];
            return `https://i.gyazo.com/${gyazoId}.png`;
        }

        const vid = extractYouTubeVideoId(pageUrl);
        if (vid) {
            return `https://i.ytimg.com/vi/${encodeURIComponent(vid)}/maxresdefault.jpg`;
        }
        return `https://rdl.ink/render/${encodeURIComponent(pageUrl)}?mode=fillmax&fill=solid&format=webp&width=254&ar=16:9&dpr=2.25`;
    }

    // YouTube動画IDを抽出
    function extractYouTubeVideoId(rawUrl) {
        try {
            const u = new URL(rawUrl);
            // watch?v= に対応
            if ((u.hostname === 'www.youtube.com' || u.hostname === 'youtube.com' || u.hostname.endsWith('.youtube.com')) && u.pathname === '/watch') {
                return u.searchParams.get('v');
            }
            // youtu.be に対応
            if (u.hostname === 'youtu.be') {
                const seg = u.pathname.replace(/^\//, '');
                return seg || null;
            }
            // embed に対応
            if ((u.hostname === 'www.youtube.com' || u.hostname === 'youtube.com' || u.hostname.endsWith('.youtube.com')) && u.pathname.startsWith('/embed/')) {
                const seg = u.pathname.split('/embed/')[1];
                return seg || null;
            }
            return null;
        } catch (_) {
            return null;
        }
    }

    // 投稿一覧取得
    async function fetchAllPosts() {
        if (postOnlyMode) return;
        const response = await fetch('/search?q=');
        allPosts = await response.json();
        renderPosts(allPosts);
        updatePostCount();
    }

    function linkifyHashtags(text) {
        return text.replace(/#(\w+)/g, '<span class="post-hashtag" onclick="inputHashtag(\'$1\')">#$1</span>');
    }
    // ハッシュタグをinputに代入してfilterPostsを実行
    function inputHashtag(hashtag) {
        input.value = '#' + hashtag;
        filterPosts('#' + hashtag);
    }

    function renderPosts(posts) {
        postsList.innerHTML = posts.map(post => {
            // 1. まずURLをサムネイルリンクに置換
            let content = post.content;
            content = content.replace(/((https?:\/\/[^\s]+))/g, (match, url) => {
                return `<a href="${url}" target="_blank" class="post-thumbnail-link" data-encoded-url="${url}">
                <img src="${getThumbnailUrl(url)}" alt="サムネイル" class="post-thumbnail" onerror="this.style.display='none'; this.parentNode.innerHTML='${url}';">
            </a>`;
            });
            // 2. ハッシュタグをリンクに置換
            content = linkifyHashtags(content);
            return `
            <li class="post ${post.is_highlight ? 'highlight' : ''}"
                data-time="${new Date(post.created_at).toLocaleString()}"
                data-id="${post.id}"
                style="${post.is_highlight ? `background-color: ${post.highlight_color || ''};` : ''}">
                ${content}
            </li>
        `;
        }).join('');
        document.querySelectorAll('.post.highlight').forEach(el => {
            applyHighlightColor(el, true);
        });
    }


    // 投稿数更新
    function updatePostCount() {
        postCountElement.textContent = `${allPosts.length} Posts`;
    }

    // 投稿フィルタリング
    function filterPosts(query) {
        if (postOnlyMode || !query) {
            if (!postOnlyMode) renderPosts(allPosts);
            isSearchMode = false;
            return;
        }

        function normalize(s) {
            return s.replace(/[ァ-ヴ]/g, m => String.fromCharCode(m.charCodeAt(0) - 0x60))
                .replace(/[Ａ-Ｚａ-ｚ０-９]/g, m => String.fromCharCode(m.charCodeAt(0) - 0xFEE0))
                .toLowerCase()
                .trim();
        }

        isSearchMode = true;
        const aliasMap = {};
        allPosts.forEach(post => {
            const eqMatch = post.content.match(/^([^[=\s]+)\s*=\s*([^=\s]+)$/);
            if (eqMatch) {
                const a = normalize(eqMatch[1]), b = normalize(eqMatch[2]);
                aliasMap[a] = b;
                aliasMap[b] = a;
            } else if (post.content.includes('=')) {
                const eqParts = post.content.split('=');
                if (eqParts.length === 2) {
                    const a = normalize(eqParts[0]), b = normalize(eqParts[1]);
                    aliasMap[a] = b;
                    aliasMap[b] = a;
                }
            }
        });

        const queries = [normalize(query)];
        if (aliasMap[queries[0]]) queries.push(aliasMap[queries[0]]);

        // エンコードされたURLも検索対象に含める
        const encodedQuery = encodeURIComponent(query);

        const filtered = allPosts.filter(post => {
            let aliasList = [post.content];
            const eqMatch = post.content.match(/^([^[=\s]+)\s*=\s*([^=\s]+)$/);
            if (eqMatch) {
                aliasList.push(eqMatch[1], eqMatch[2]);
            } else if (post.content.includes('=')) {
                const eqParts = post.content.split('=');
                if (eqParts.length === 2) aliasList.push(eqParts[0], eqParts[1]);
            }

            // URLの場合はエンコードされた文字列も検索対象に含める
            if (post.content.startsWith('http://') || post.content.startsWith('https://')) {
                const encodedContent = encodeURIComponent(post.content);
                return queries.some(q => aliasList.some(str => normalize(str).includes(q))) ||
                    encodedContent.includes(encodedQuery);
            } else {
                return queries.some(q => aliasList.some(str => normalize(str).includes(q)));
            }
        });

        renderPosts(filtered);
        saveSearchQuery(query);
    }

    // 投稿送信
    async function postContent(content) {
        await fetch('/post', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content }),
        });
        history.replaceState({}, '', window.location.pathname);
        if (!postOnlyMode) await fetchAllPosts();
        // 投稿後にURLパラメータを消す
    }


    // URL表示
    function showUrlWithToken() {
        const token = getTokenFromCookie();
        const url = `${window.location.origin}${postOnlyMode ? '?postonly=yes&' : '?'}token=${token}`;
        shareUrlElement.href = url;
        shareUrlElement.textContent = url;
        document.getElementById('qrcode').innerHTML =
            `<img src="https://idy.vercel.app/q/${encodeURIComponent(url)}" alt="QRコード">`;
        urlContent.style.display = 'block';
        searchHistory.style.display = 'none';
    }

    // CSVダウンロード
    function downloadCsv() {
        if (postOnlyMode) {
            alert('投稿専用モードではデータをダウンロードできません。');
            return;
        }
        const csvHeader = ['タイムスタンプ,メモ内容'];
        const csvRows = allPosts.map(post =>
            `"${new Date(post.created_at).toLocaleString()}",${post.content.replace(/\"/g, '""')}"`
        );
        const csvContent = [...csvHeader, ...csvRows].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'microblog_export.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // 統計ページへ
    function goToStats() {
        window.location.href = '/stats';
    }

    // 今日の投稿を送信
    function sendTodayPosts() {
        const now = new Date();
        const jstOffset = 9 * 60 * 60 * 1000;
        const jstDate = new Date(now.getTime() + jstOffset).toISOString().split('T')[0];
        const todayPosts = allPosts.filter(post => {
            const postDate = new Date(post.created_at);
            const postJstDate = new Date(postDate.getTime() + jstOffset).toISOString().split('T')[0];
            return postJstDate === jstDate;
        });
        if (todayPosts.length === 0) return;
        const message = todayPosts.map(post =>
            `${new Date(post.created_at).toLocaleTimeString()}：${post.content}`
        ).join('\n');
        const prompt = `これはランダムなつぶやきです。MECEに整理してください。\n\n${message}`;
        const encodedMessage = encodeURIComponent(prompt);
        const url = `https://chat.mistral.ai/chat?q=${encodedMessage}`;
        window.open(url, '_blank');
    }

    // 検索履歴保存
    function saveSearchQuery(query) {
        const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        if (!history.includes(query)) {
            history.unshift(query);
            localStorage.setItem('searchHistory', JSON.stringify(history.slice(0, 10)));
            updateHistoryDisplay();
        }
    }

    // 検索履歴表示更新
    function updateHistoryDisplay() {
        const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        historyList.innerHTML = history.map(q =>
            `<li onclick="filterPosts('${q}')">${q}</li>`
        ).join('');
    }

    // ハイライト色適用
    function applyHighlightColor(postElement, isHighlighted) {
        if (isHighlighted) {
            const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const pastelColors = isDarkMode ? darkPastelColors : lightPastelColors;
            const shuffledColors = shuffleArray([...pastelColors]);
            const randomColor = shuffledColors[0];
            postElement.style.backgroundColor = randomColor;
            postElement.classList.add('highlight');
        } else {
            postElement.style.backgroundColor = '';
            postElement.classList.remove('highlight');
        }
    }

    // イベントリスナー
    document.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        urlContent.style.display = 'none';
        searchHistory.style.display = 'none';
        modal.classList.add('show');
        modal.style.display = 'block';
    });

    window.onclick = (event) => {
        if (event.target === modal) modal.style.display = 'none';
    };

    showUrlBtn.addEventListener('click', showUrlWithToken);
    downloadCsvBtn.addEventListener('click', downloadCsv);
    statsBtn.addEventListener('click', goToStats);
    showHistoryBtn.addEventListener('click', () => {
        searchHistory.style.display = 'block';
        urlContent.style.display = 'none';
        updateHistoryDisplay();
    });
    sendTodayPostsBtn.addEventListener('click', sendTodayPosts);

    input.addEventListener('input', (e) => filterPosts(e.target.value));
    input.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter' && input.value.trim() && !isPosting) {
            const content = input.value.trim();
            input.value = '';
            input.disabled = true;
            isPosting = true;
            const dummyPost = {
                content: content,
                created_at: new Date().toISOString(),
                id: Date.now(),
                is_highlight: false
            };
            allPosts = [dummyPost, ...allPosts];
            renderPosts(allPosts);
            input.focus(); // ここでフォーカスを戻す
            try {
                await postContent(content);
            } finally {
                input.disabled = false;
                isPosting = false;
                input.focus(); // 非同期処理完了後にもフォーカスを戻す
            }
        }
    });

    // 投稿のダブルクリックイベント
    postsList.addEventListener('dblclick', (e) => {
        if (e.target.closest('a')) return;
        const postElement = e.target.closest('.post');
        if (!postElement) return;
        const postContent = postElement.textContent.trim();
        // Xの投稿画面を開く
        window.open(`https://x.com/intent/post?text=${encodeURIComponent(postContent)}`, '_blank');
    });


    // inputのダブルクリックイベント
    input.addEventListener('dblclick', () => {
        hideThumbnailPosts = !hideThumbnailPosts;
        if (hideThumbnailPosts) {
            const filteredPosts = allPosts.filter(post =>
                !(post.content.startsWith('http://') || post.content.startsWith('https://'))
            );
            renderPosts(filteredPosts);
        } else {
            renderPosts(allPosts);
        }
    });

    // postsList のクリックイベントハンドラを修正
    postsList.addEventListener('click', async (e) => {
        if (e.target.closest('a')) return;
        const postElement = e.target.closest('.post');
        if (!postElement) return;
        if (e.target.tagName === 'A') return;
        const postId = postElement.getAttribute('data-id');
        if (!postId) return;
        const currentPost = allPosts.find(post => post.id == postId);
        if (!currentPost) return;

        // 検索モードの場合
        if (isSearchMode) {
            // 絞り込みを解除して全件表示
            renderPosts(allPosts);
            isSearchMode = false;
            // 該当投稿にスクロール
            const allPostElements = document.querySelectorAll('.post');
            const targetElement = Array.from(allPostElements).find(el => el.getAttribute('data-id') == postId);
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // ハイライトを一時的に適用（視認性向上）
                targetElement.classList.add('highlight');
                setTimeout(() => {
                    targetElement.classList.remove('highlight');
                }, 2000);
            }
            return;
        }

        // 従来のハイライトトグル・発声・クリップボードコピー
        const isHighlighted = currentPost.is_highlight;
        const willBeHighlighted = !isHighlighted;
        if (willBeHighlighted) {
            const utterance = new SpeechSynthesisUtterance(currentPost.content);
            window.speechSynthesis.speak(utterance);
        }
        applyHighlightColor(postElement, willBeHighlighted);
        try {
            await navigator.clipboard.writeText(currentPost.content);
        } catch (err) {
            console.error('Failed to copy:', err);
        }
        try {
            const response = await fetch('/highlight', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: postId, is_highlight: willBeHighlighted }),
            });
            if (response.ok) {
                currentPost.is_highlight = willBeHighlighted;
            } else {
                applyHighlightColor(postElement, isHighlighted);
                alert('ハイライトの更新に失敗しました。');
            }
        } catch (error) {
            console.error('Error updating highlight:', error);
            applyHighlightColor(postElement, isHighlighted);
            alert('ハイライトの更新に失敗しました。');
        }
    });


    let showOnlyHighlighted = false;
    input.addEventListener('click', () => {
        if (input.value.trim() === '') {
            showOnlyHighlighted = !showOnlyHighlighted;
            if (showOnlyHighlighted) {
                const highlightedPosts = allPosts.filter(post => post.is_highlight);
                renderPosts(highlightedPosts);
            } else {
                renderPosts(allPosts);
            }
        }
    });

    if (postParam) {
        input.value = postParam;
        const event = new KeyboardEvent('keydown', { key: 'Enter' });
        input.dispatchEvent(event);
    }

    if (!postOnlyMode) fetchAllPosts();
    input.focus();
    // ページにフォーカスが戻った時に最新ポストを取得
    document.addEventListener('visibilitychange', async () => {
        if (document.visibilityState === 'visible' && !postOnlyMode) {
            await fetchAllPosts();
        }
    });

</script>

</body>

げ id="qrcode"></div>
</div>
<div id="searchHistory">
    <h4>検索履歴</h4>
    <ul id="historyList"></ul>
</div>
</div>
</div>

<script>
    const lightPastelColors = [
        '#FFD1DC', '#FFE4B5', '#E6E6FA', '#B5EAD7', '#FFB6C1',
        '#E0FFFF', '#F0E68C', '#D8BFD8', '#FFDAB9', '#E0F6FF',
        '#F0F8FF', '#FAEBD7', '#FFE4E1', '#D3D3D3', '#F5F5DC',
        '#FFEBCD', '#F5DEB3', '#FFFACD', '#E6E6FA', '#F0FFF0'
    ];
    const darkPastelColors = [
        '#4A2D3A', '#4A412A', '#3A3A4A', '#2D4A3A', '#4A2D2D',
        '#2D3A4A', '#4A3A2D', '#3A2D4A', '#2D3A3A', '#3A3A2D',
        '#4A3A4A', '#2D2D4A', '#3A2D3A', '#413A2D', '#412D3A',
        '#4A2D41', '#2D414A', '#413A4A', '#3A412D', '#412D3A'
    ];

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function applyRandomPastelColor() {
        const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        let pastelColors = isDarkMode ? [...darkPastelColors] : [...lightPastelColors];
        pastelColors = shuffleArray(pastelColors);
        const randomColor = pastelColors[0];
        document.documentElement.style.setProperty('--bg-color', randomColor);
        const lastUpdate = localStorage.getItem('lastUpdate');
        if (lastUpdate) {
            const hoursPassed = (Date.now() - lastUpdate) / (1000 * 60 * 60);
            const sepiaValue = Math.min(hoursPassed * 0.02, 0.3);
            document.documentElement.style.setProperty('--sepia-filter', `sepia(${sepiaValue})`);
        } else {
            localStorage.setItem('lastUpdate', Date.now());
        }
    }

    window.addEventListener('load', applyRandomPastelColor);

    const urlParams = new URLSearchParams(window.location.search);
    const postOnlyMode = urlParams.get('postonly') === 'yes';
    const postParam = urlParams.get('p');

    const input = document.getElementById('post-input');
    const postsList = document.getElementById('posts');
    const modal = document.getElementById('contextModal');
    const urlContent = document.getElementById('urlContent');
    const searchHistory = document.getElementById('searchHistory');
    const historyList = document.getElementById('historyList');
    const shareUrlElement = document.getElementById('shareUrl');
    const showUrlBtn = document.getElementById('showUrlBtn');
    const downloadCsvBtn = document.getElementById('downloadCsvBtn');
    const statsBtn = document.getElementById('statsBtn');
    const showHistoryBtn = document.getElementById('showHistoryBtn');
    const sendTodayPostsBtn = document.getElementById('sendTodayPostsBtn');
    const postCountElement = document.getElementById('post-count');

    let allPosts = [];
    let isPosting = false;
    let isSearchMode = false;
    let hideThumbnailPosts = false;



    // トークン取得
    function getTokenFromCookie() {
        const urlToken = urlParams.get('token');
        if (urlToken) return urlToken;
        const cookies = document.cookie.split(';').map(cookie => cookie.trim());
        const tokenCookie = cookies.find(cookie => cookie.startsWith('token='));
        return tokenCookie ? tokenCookie.split('=')[1] : '';
    }

    function getThumbnailUrl(pageUrl) {
        const vid = extractYouTubeVideoId(pageUrl);
        if (vid) {
            return `https://i.ytimg.com/vi/${encodeURIComponent(vid)}/maxresdefault.jpg`;
        }
        return `https://rdl.ink/render/${encodeURIComponent(pageUrl)}?mode=fillmax&fill=solid&format=webp&width=254&ar=16:9&dpr=2.25`;
    }
    // YouTube動画IDを抽出
    function extractYouTubeVideoId(rawUrl) {
        try {
            const u = new URL(rawUrl);
            // watch?v= に対応
            if ((u.hostname === 'www.youtube.com' || u.hostname === 'youtube.com' || u.hostname.endsWith('.youtube.com')) && u.pathname === '/watch') {
                return u.searchParams.get('v');
            }
            // youtu.be に対応
            if (u.hostname === 'youtu.be') {
                const seg = u.pathname.replace(/^\//, '');
                return seg || null;
            }
            // embed に対応
            if ((u.hostname === 'www.youtube.com' || u.hostname === 'youtube.com' || u.hostname.endsWith('.youtube.com')) && u.pathname.startsWith('/embed/')) {
                const seg = u.pathname.split('/embed/')[1];
                return seg || null;
            }
            return null;
        } catch (_) {
            return null;
        }
    }

    // 投稿一覧取得
    async function fetchAllPosts() {
        if (postOnlyMode) return;
        const response = await fetch('/search?q=');
        allPosts = await response.json();
        renderPosts(allPosts);
        updatePostCount();
    }

    function linkifyHashtags(text) {
        return text.replace(/#(\w+)/g, '<span class="post-hashtag" onclick="inputHashtag(\'$1\')">#$1</span>');
    }
    // ハッシュタグをinputに代入してfilterPostsを実行
    function inputHashtag(hashtag) {
        input.value = '#' + hashtag;
        filterPosts('#' + hashtag);
    }

    function renderPosts(posts) {
        postsList.innerHTML = posts.map(post => {
            // 1. まずURLをサムネイルリンクに置換
            let content = post.content;
            content = content.replace(/((https?:\/\/[^\s]+))/g, (match, url) => {
                return `<a href="${url}" target="_blank" class="post-thumbnail-link" data-encoded-url="${url}">
                <img src="${getThumbnailUrl(url)}" alt="サムネイル" class="post-thumbnail" onerror="this.style.display='none'; this.parentNode.innerHTML='${url}';">
            </a>`;
            });
            // 2. ハッシュタグをリンクに置換
            content = linkifyHashtags(content);
            return `
            <li class="post ${post.is_highlight ? 'highlight' : ''}"
                data-time="${new Date(post.created_at).toLocaleString()}"
                data-id="${post.id}"
                style="${post.is_highlight ? `background-color: ${post.highlight_color || ''};` : ''}">
                ${content}
            </li>
        `;
        }).join('');
        document.querySelectorAll('.post.highlight').forEach(el => {
            applyHighlightColor(el, true);
        });
    }


    // 投稿数更新
    function updatePostCount() {
        postCountElement.textContent = `${allPosts.length} Posts`;
    }

    // 投稿フィルタリング
    function filterPosts(query) {
        if (postOnlyMode || !query) {
            if (!postOnlyMode) renderPosts(allPosts);
            isSearchMode = false;
            return;
        }

        function normalize(s) {
            return s.replace(/[ァ-ヴ]/g, m => String.fromCharCode(m.charCodeAt(0) - 0x60))
                .replace(/[Ａ-Ｚａ-ｚ０-９]/g, m => String.fromCharCode(m.charCodeAt(0) - 0xFEE0))
                .toLowerCase()
                .trim();
        }

        isSearchMode = true;
        const aliasMap = {};
        allPosts.forEach(post => {
            const eqMatch = post.content.match(/^([^[=\s]+)\s*=\s*([^=\s]+)$/);
            if (eqMatch) {
                const a = normalize(eqMatch[1]), b = normalize(eqMatch[2]);
                aliasMap[a] = b;
                aliasMap[b] = a;
            } else if (post.content.includes('=')) {
                const eqParts = post.content.split('=');
                if (eqParts.length === 2) {
                    const a = normalize(eqParts[0]), b = normalize(eqParts[1]);
                    aliasMap[a] = b;
                    aliasMap[b] = a;
                }
            }
        });

        const queries = [normalize(query)];
        if (aliasMap[queries[0]]) queries.push(aliasMap[queries[0]]);

        // エンコードされたURLも検索対象に含める
        const encodedQuery = encodeURIComponent(query);

        const filtered = allPosts.filter(post => {
            let aliasList = [post.content];
            const eqMatch = post.content.match(/^([^[=\s]+)\s*=\s*([^=\s]+)$/);
            if (eqMatch) {
                aliasList.push(eqMatch[1], eqMatch[2]);
            } else if (post.content.includes('=')) {
                const eqParts = post.content.split('=');
                if (eqParts.length === 2) aliasList.push(eqParts[0], eqParts[1]);
            }

            // URLの場合はエンコードされた文字列も検索対象に含める
            if (post.content.startsWith('http://') || post.content.startsWith('https://')) {
                const encodedContent = encodeURIComponent(post.content);
                return queries.some(q => aliasList.some(str => normalize(str).includes(q))) ||
                    encodedContent.includes(encodedQuery);
            } else {
                return queries.some(q => aliasList.some(str => normalize(str).includes(q)));
            }
        });

        renderPosts(filtered);
        saveSearchQuery(query);
    }

    // 投稿送信
    async function postContent(content) {
        await fetch('/post', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content }),
        });
        history.replaceState({}, '', window.location.pathname);
        if (!postOnlyMode) await fetchAllPosts();
        // 投稿後にURLパラメータを消す
    }


    // URL表示
    function showUrlWithToken() {
        const token = getTokenFromCookie();
        const url = `${window.location.origin}${postOnlyMode ? '?postonly=yes&' : '?'}token=${token}`;
        shareUrlElement.href = url;
        shareUrlElement.textContent = url;
        document.getElementById('qrcode').innerHTML =
            `<img src="https://idy.vercel.app/q/${encodeURIComponent(url)}" alt="QRコード">`;
        urlContent.style.display = 'block';
        searchHistory.style.display = 'none';
    }

    // CSVダウンロード
    function downloadCsv() {
        if (postOnlyMode) {
            alert('投稿専用モードではデータをダウンロードできません。');
            return;
        }
        const csvHeader = ['タイムスタンプ,メモ内容'];
        const csvRows = allPosts.map(post =>
            `"${new Date(post.created_at).toLocaleString()}",${post.content.replace(/\"/g, '""')}"`
        );
        const csvContent = [...csvHeader, ...csvRows].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'microblog_export.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // 統計ページへ
    function goToStats() {
        window.location.href = '/stats';
    }

    // 今日の投稿を送信
    function sendTodayPosts() {
        const now = new Date();
        const jstOffset = 9 * 60 * 60 * 1000;
        const jstDate = new Date(now.getTime() + jstOffset).toISOString().split('T')[0];
        const todayPosts = allPosts.filter(post => {
            const postDate = new Date(post.created_at);
            const postJstDate = new Date(postDate.getTime() + jstOffset).toISOString().split('T')[0];
            return postJstDate === jstDate;
        });
        if (todayPosts.length === 0) return;
        const message = todayPosts.map(post =>
            `${new Date(post.created_at).toLocaleTimeString()}：${post.content}`
        ).join('\n');
        const prompt = `これはランダムなつぶやきです。MECEに整理してください。\n\n${message}`;
        const encodedMessage = encodeURIComponent(prompt);
        const url = `https://chat.mistral.ai/chat?q=${encodedMessage}`;
        window.open(url, '_blank');
    }

    // 検索履歴保存
    function saveSearchQuery(query) {
        const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        if (!history.includes(query)) {
            history.unshift(query);
            localStorage.setItem('searchHistory', JSON.stringify(history.slice(0, 10)));
            updateHistoryDisplay();
        }
    }

    // 検索履歴表示更新
    function updateHistoryDisplay() {
        const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        historyList.innerHTML = history.map(q =>
            `<li onclick="filterPosts('${q}')">${q}</li>`
        ).join('');
    }

    // ハイライト色適用
    function applyHighlightColor(postElement, isHighlighted) {
        if (isHighlighted) {
            const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const pastelColors = isDarkMode ? darkPastelColors : lightPastelColors;
            const shuffledColors = shuffleArray([...pastelColors]);
            const randomColor = shuffledColors[0];
            postElement.style.backgroundColor = randomColor;
            postElement.classList.add('highlight');
        } else {
            postElement.style.backgroundColor = '';
            postElement.classList.remove('highlight');
        }
    }

    // イベントリスナー
    document.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        urlContent.style.display = 'none';
        searchHistory.style.display = 'none';
        modal.classList.add('show');
        modal.style.display = 'block';
    });

    window.onclick = (event) => {
        if (event.target === modal) modal.style.display = 'none';
    };

    showUrlBtn.addEventListener('click', showUrlWithToken);
    downloadCsvBtn.addEventListener('click', downloadCsv);
    statsBtn.addEventListener('click', goToStats);
    showHistoryBtn.addEventListener('click', () => {
        searchHistory.style.display = 'block';
        urlContent.style.display = 'none';
        updateHistoryDisplay();
    });
    sendTodayPostsBtn.addEventListener('click', sendTodayPosts);

    input.addEventListener('input', (e) => filterPosts(e.target.value));
    input.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter' && input.value.trim() && !isPosting) {
            const content = input.value.trim();
            input.value = '';
            input.disabled = true;
            isPosting = true;
            const dummyPost = {
                content: content,
                created_at: new Date().toISOString(),
                id: Date.now(),
                is_highlight: false
            };
            allPosts = [dummyPost, ...allPosts];
            renderPosts(allPosts);
            input.focus(); // ここでフォーカスを戻す
            try {
                await postContent(content);
            } finally {
                input.disabled = false;
                isPosting = false;
                input.focus(); // 非同期処理完了後にもフォーカスを戻す
            }
        }
    });

    // 投稿のダブルクリックイベント
    postsList.addEventListener('dblclick', (e) => {
        if (e.target.closest('a')) return;
        const postElement = e.target.closest('.post');
        if (!postElement) return;
        const postContent = postElement.textContent.trim();
        // Xの投稿画面を開く
        window.open(`https://x.com/intent/post?text=${encodeURIComponent(postContent)}`, '_blank');
    });


    // inputのダブルクリックイベント
    input.addEventListener('dblclick', () => {
        hideThumbnailPosts = !hideThumbnailPosts;
        if (hideThumbnailPosts) {
            const filteredPosts = allPosts.filter(post =>
                !(post.content.startsWith('http://') || post.content.startsWith('https://'))
            );
            renderPosts(filteredPosts);
        } else {
            renderPosts(allPosts);
        }
    });

    // postsList のクリックイベントハンドラを修正
    postsList.addEventListener('click', async (e) => {
        if (e.target.closest('a')) return;
        const postElement = e.target.closest('.post');
        if (!postElement) return;
        if (e.target.tagName === 'A') return;
        const postId = postElement.getAttribute('data-id');
        if (!postId) return;
        const currentPost = allPosts.find(post => post.id == postId);
        if (!currentPost) return;

        // 検索モードの場合
        if (isSearchMode) {
            // 絞り込みを解除して全件表示
            renderPosts(allPosts);
            isSearchMode = false;
            // 該当投稿にスクロール
            const allPostElements = document.querySelectorAll('.post');
            const targetElement = Array.from(allPostElements).find(el => el.getAttribute('data-id') == postId);
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // ハイライトを一時的に適用（視認性向上）
                targetElement.classList.add('highlight');
                setTimeout(() => {
                    targetElement.classList.remove('highlight');
                }, 2000);
            }
            return;
        }

        // 従来のハイライトトグル・発声・クリップボードコピー
        const isHighlighted = currentPost.is_highlight;
        const willBeHighlighted = !isHighlighted;
        if (willBeHighlighted) {
            const utterance = new SpeechSynthesisUtterance(currentPost.content);
            window.speechSynthesis.speak(utterance);
        }
        applyHighlightColor(postElement, willBeHighlighted);
        try {
            await navigator.clipboard.writeText(currentPost.content);
        } catch (err) {
            console.error('Failed to copy:', err);
        }
        try {
            const response = await fetch('/highlight', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: postId, is_highlight: willBeHighlighted }),
            });
            if (response.ok) {
                currentPost.is_highlight = willBeHighlighted;
            } else {
                applyHighlightColor(postElement, isHighlighted);
                alert('ハイライトの更新に失敗しました。');
            }
        } catch (error) {
            console.error('Error updating highlight:', error);
            applyHighlightColor(postElement, isHighlighted);
            alert('ハイライトの更新に失敗しました。');
        }
    });


    let showOnlyHighlighted = false;
    input.addEventListener('click', () => {
        if (input.value.trim() === '') {
            showOnlyHighlighted = !showOnlyHighlighted;
            if (showOnlyHighlighted) {
                const highlightedPosts = allPosts.filter(post => post.is_highlight);
                renderPosts(highlightedPosts);
            } else {
                renderPosts(allPosts);
            }
        }
    });

    if (postParam) {
        input.value = postParam;
        const event = new KeyboardEvent('keydown', { key: 'Enter' });
        input.dispatchEvent(event);
    }

    if (!postOnlyMode) fetchAllPosts();
    input.focus();
    // ページにフォーカスが戻った時に最新ポストを取得
    document.addEventListener('visibilitychange', async () => {
        if (document.visibilityState === 'visible' && !postOnlyMode) {
            await fetchAllPosts();
        }
    });

</script>

</body>

げｔ id="qrcode"></div>
</div>
<div id="searchHistory">
    <h4>検索履歴</h4>
    <ul id="historyList"></ul>
</div>
</div>
</div>

<script>
    const lightPastelColors = [
        '#FFD1DC', '#FFE4B5', '#E6E6FA', '#B5EAD7', '#FFB6C1',
        '#E0FFFF', '#F0E68C', '#D8BFD8', '#FFDAB9', '#E0F6FF',
        '#F0F8FF', '#FAEBD7', '#FFE4E1', '#D3D3D3', '#F5F5DC',
        '#FFEBCD', '#F5DEB3', '#FFFACD', '#E6E6FA', '#F0FFF0'
    ];
    const darkPastelColors = [
        '#4A2D3A', '#4A412A', '#3A3A4A', '#2D4A3A', '#4A2D2D',
        '#2D3A4A', '#4A3A2D', '#3A2D4A', '#2D3A3A', '#3A3A2D',
        '#4A3A4A', '#2D2D4A', '#3A2D3A', '#413A2D', '#412D3A',
        '#4A2D41', '#2D414A', '#413A4A', '#3A412D', '#412D3A'
    ];

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function applyRandomPastelColor() {
        const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        let pastelColors = isDarkMode ? [...darkPastelColors] : [...lightPastelColors];
        pastelColors = shuffleArray(pastelColors);
        const randomColor = pastelColors[0];
        document.documentElement.style.setProperty('--bg-color', randomColor);
        const lastUpdate = localStorage.getItem('lastUpdate');
        if (lastUpdate) {
            const hoursPassed = (Date.now() - lastUpdate) / (1000 * 60 * 60);
            const sepiaValue = Math.min(hoursPassed * 0.02, 0.3);
            document.documentElement.style.setProperty('--sepia-filter', `sepia(${sepiaValue})`);
        } else {
            localStorage.setItem('lastUpdate', Date.now());
        }
    }

    window.addEventListener('load', applyRandomPastelColor);

    const urlParams = new URLSearchParams(window.location.search);
    const postOnlyMode = urlParams.get('postonly') === 'yes';
    const postParam = urlParams.get('p');

    const input = document.getElementById('post-input');
    const postsList = document.getElementById('posts');
    const modal = document.getElementById('contextModal');
    const urlContent = document.getElementById('urlContent');
    const searchHistory = document.getElementById('searchHistory');
    const historyList = document.getElementById('historyList');
    const shareUrlElement = document.getElementById('shareUrl');
    const showUrlBtn = document.getElementById('showUrlBtn');
    const downloadCsvBtn = document.getElementById('downloadCsvBtn');
    const statsBtn = document.getElementById('statsBtn');
    const showHistoryBtn = document.getElementById('showHistoryBtn');
    const sendTodayPostsBtn = document.getElementById('sendTodayPostsBtn');
    const postCountElement = document.getElementById('post-count');

    let allPosts = [];
    let isPosting = false;
    let isSearchMode = false;
    let hideThumbnailPosts = false;



    // トークン取得
    function getTokenFromCookie() {
        const urlToken = urlParams.get('token');
        if (urlToken) return urlToken;
        const cookies = document.cookie.split(';').map(cookie => cookie.trim());
        const tokenCookie = cookies.find(cookie => cookie.startsWith('token='));
        return tokenCookie ? tokenCookie.split('=')[1] : '';
    }

    function getThumbnailUrl(pageUrl) {
        const vid = extractYouTubeVideoId(pageUrl);
        if (vid) {
            return `https://i.ytimg.com/vi/${encodeURIComponent(vid)}/maxresdefault.jpg`;
        }
        return `https://rdl.ink/render/${encodeURIComponent(pageUrl)}?mode=fillmax&fill=solid&format=webp&width=254&ar=16:9&dpr=2.25`;
    }
    // YouTube動画IDを抽出
    function extractYouTubeVideoId(rawUrl) {
        try {
            const u = new URL(rawUrl);
            // watch?v= に対応
            if ((u.hostname === 'www.youtube.com' || u.hostname === 'youtube.com' || u.hostname.endsWith('.youtube.com')) && u.pathname === '/watch') {
                return u.searchParams.get('v');
            }
            // youtu.be に対応
            if (u.hostname === 'youtu.be') {
                const seg = u.pathname.replace(/^\//, '');
                return seg || null;
            }
            // embed に対応
            if ((u.hostname === 'www.youtube.com' || u.hostname === 'youtube.com' || u.hostname.endsWith('.youtube.com')) && u.pathname.startsWith('/embed/')) {
                const seg = u.pathname.split('/embed/')[1];
                return seg || null;
            }
            return null;
        } catch (_) {
            return null;
        }
    }

    // 投稿一覧取得
    async function fetchAllPosts() {
        if (postOnlyMode) return;
        const response = await fetch('/search?q=');
        allPosts = await response.json();
        renderPosts(allPosts);
        updatePostCount();
    }

    function linkifyHashtags(text) {
        return text.replace(/#(\w+)/g, '<span class="post-hashtag" onclick="inputHashtag(\'$1\')">#$1</span>');
    }
    // ハッシュタグをinputに代入してfilterPostsを実行
    function inputHashtag(hashtag) {
        input.value = '#' + hashtag;
        filterPosts('#' + hashtag);
    }

    function renderPosts(posts) {
        postsList.innerHTML = posts.map(post => {
            // 1. まずURLをサムネイルリンクに置換
            let content = post.content;
            content = content.replace(/((https?:\/\/[^\s]+))/g, (match, url) => {
                return `<a href="${url}" target="_blank" class="post-thumbnail-link" data-encoded-url="${url}">
                <img src="${getThumbnailUrl(url)}" alt="サムネイル" class="post-thumbnail" onerror="this.style.display='none'; this.parentNode.innerHTML='${url}';">
            </a>`;
            });
            // 2. ハッシュタグをリンクに置換
            content = linkifyHashtags(content);
            return `
            <li class="post ${post.is_highlight ? 'highlight' : ''}"
                data-time="${new Date(post.created_at).toLocaleString()}"
                data-id="${post.id}"
                style="${post.is_highlight ? `background-color: ${post.highlight_color || ''};` : ''}">
                ${content}
            </li>
        `;
        }).join('');
        document.querySelectorAll('.post.highlight').forEach(el => {
            applyHighlightColor(el, true);
        });
    }


    // 投稿数更新
    function updatePostCount() {
        postCountElement.textContent = `${allPosts.length} Posts`;
    }

    // 投稿フィルタリング
    function filterPosts(query) {
        if (postOnlyMode || !query) {
            if (!postOnlyMode) renderPosts(allPosts);
            isSearchMode = false;
            return;
        }

        function normalize(s) {
            return s.replace(/[ァ-ヴ]/g, m => String.fromCharCode(m.charCodeAt(0) - 0x60))
                .replace(/[Ａ-Ｚａ-ｚ０-９]/g, m => String.fromCharCode(m.charCodeAt(0) - 0xFEE0))
                .toLowerCase()
                .trim();
        }

        isSearchMode = true;
        const aliasMap = {};
        allPosts.forEach(post => {
            const eqMatch = post.content.match(/^([^[=\s]+)\s*=\s*([^=\s]+)$/);
            if (eqMatch) {
                const a = normalize(eqMatch[1]), b = normalize(eqMatch[2]);
                aliasMap[a] = b;
                aliasMap[b] = a;
            } else if (post.content.includes('=')) {
                const eqParts = post.content.split('=');
                if (eqParts.length === 2) {
                    const a = normalize(eqParts[0]), b = normalize(eqParts[1]);
                    aliasMap[a] = b;
                    aliasMap[b] = a;
                }
            }
        });

        const queries = [normalize(query)];
        if (aliasMap[queries[0]]) queries.push(aliasMap[queries[0]]);

        // エンコードされたURLも検索対象に含める
        const encodedQuery = encodeURIComponent(query);

        const filtered = allPosts.filter(post => {
            let aliasList = [post.content];
            const eqMatch = post.content.match(/^([^[=\s]+)\s*=\s*([^=\s]+)$/);
            if (eqMatch) {
                aliasList.push(eqMatch[1], eqMatch[2]);
            } else if (post.content.includes('=')) {
                const eqParts = post.content.split('=');
                if (eqParts.length === 2) aliasList.push(eqParts[0], eqParts[1]);
            }

            // URLの場合はエンコードされた文字列も検索対象に含める
            if (post.content.startsWith('http://') || post.content.startsWith('https://')) {
                const encodedContent = encodeURIComponent(post.content);
                return queries.some(q => aliasList.some(str => normalize(str).includes(q))) ||
                    encodedContent.includes(encodedQuery);
            } else {
                return queries.some(q => aliasList.some(str => normalize(str).includes(q)));
            }
        });

        renderPosts(filtered);
        saveSearchQuery(query);
    }

    // 投稿送信
    async function postContent(content) {
        await fetch('/post', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content }),
        });
        history.replaceState({}, '', window.location.pathname);
        if (!postOnlyMode) await fetchAllPosts();
        // 投稿後にURLパラメータを消す
    }


    // URL表示
    function showUrlWithToken() {
        const token = getTokenFromCookie();
        const url = `${window.location.origin}${postOnlyMode ? '?postonly=yes&' : '?'}token=${token}`;
        shareUrlElement.href = url;
        shareUrlElement.textContent = url;
        document.getElementById('qrcode').innerHTML =
            `<img src="https://idy.vercel.app/q/${encodeURIComponent(url)}" alt="QRコード">`;
        urlContent.style.display = 'block';
        searchHistory.style.display = 'none';
    }

    // CSVダウンロード
    function downloadCsv() {
        if (postOnlyMode) {
            alert('投稿専用モードではデータをダウンロードできません。');
            return;
        }
        const csvHeader = ['タイムスタンプ,メモ内容'];
        const csvRows = allPosts.map(post =>
            `"${new Date(post.created_at).toLocaleString()}",${post.content.replace(/\"/g, '""')}"`
        );
        const csvContent = [...csvHeader, ...csvRows].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'microblog_export.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // 統計ページへ
    function goToStats() {
        window.location.href = '/stats';
    }

    // 今日の投稿を送信
    function sendTodayPosts() {
        const now = new Date();
        const jstOffset = 9 * 60 * 60 * 1000;
        const jstDate = new Date(now.getTime() + jstOffset).toISOString().split('T')[0];
        const todayPosts = allPosts.filter(post => {
            const postDate = new Date(post.created_at);
            const postJstDate = new Date(postDate.getTime() + jstOffset).toISOString().split('T')[0];
            return postJstDate === jstDate;
        });
        if (todayPosts.length === 0) return;
        const message = todayPosts.map(post =>
            `${new Date(post.created_at).toLocaleTimeString()}：${post.content}`
        ).join('\n');
        const prompt = `これはランダムなつぶやきです。MECEに整理してください。\n\n${message}`;
        const encodedMessage = encodeURIComponent(prompt);
        const url = `https://chat.mistral.ai/chat?q=${encodedMessage}`;
        window.open(url, '_blank');
    }

    // 検索履歴保存
    function saveSearchQuery(query) {
        const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        if (!history.includes(query)) {
            history.unshift(query);
            localStorage.setItem('searchHistory', JSON.stringify(history.slice(0, 10)));
            updateHistoryDisplay();
        }
    }

    // 検索履歴表示更新
    function updateHistoryDisplay() {
        const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        historyList.innerHTML = history.map(q =>
            `<li onclick="filterPosts('${q}')">${q}</li>`
        ).join('');
    }

    // ハイライト色適用
    function applyHighlightColor(postElement, isHighlighted) {
        if (isHighlighted) {
            const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const pastelColors = isDarkMode ? darkPastelColors : lightPastelColors;
            const shuffledColors = shuffleArray([...pastelColors]);
            const randomColor = shuffledColors[0];
            postElement.style.backgroundColor = randomColor;
            postElement.classList.add('highlight');
        } else {
            postElement.style.backgroundColor = '';
            postElement.classList.remove('highlight');
        }
    }

    // イベントリスナー
    document.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        urlContent.style.display = 'none';
        searchHistory.style.display = 'none';
        modal.classList.add('show');
        modal.style.display = 'block';
    });

    window.onclick = (event) => {
        if (event.target === modal) modal.style.display = 'none';
    };

    showUrlBtn.addEventListener('click', showUrlWithToken);
    downloadCsvBtn.addEventListener('click', downloadCsv);
    statsBtn.addEventListener('click', goToStats);
    showHistoryBtn.addEventListener('click', () => {
        searchHistory.style.display = 'block';
        urlContent.style.display = 'none';
        updateHistoryDisplay();
    });
    sendTodayPostsBtn.addEventListener('click', sendTodayPosts);

    input.addEventListener('input', (e) => filterPosts(e.target.value));
    input.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter' && input.value.trim() && !isPosting) {
            const content = input.value.trim();
            input.value = '';
            input.disabled = true;
            isPosting = true;
            const dummyPost = {
                content: content,
                created_at: new Date().toISOString(),
                id: Date.now(),
                is_highlight: false
            };
            allPosts = [dummyPost, ...allPosts];
            renderPosts(allPosts);
            input.focus(); // ここでフォーカスを戻す
            try {
                await postContent(content);
            } finally {
                input.disabled = false;
                isPosting = false;
                input.focus(); // 非同期処理完了後にもフォーカスを戻す
            }
        }
    });

    // 投稿のダブルクリックイベント
    postsList.addEventListener('dblclick', (e) => {
        if (e.target.closest('a')) return;
        const postElement = e.target.closest('.post');
        if (!postElement) return;
        const postContent = postElement.textContent.trim();
        // Xの投稿画面を開く
        window.open(`https://x.com/intent/post?text=${encodeURIComponent(postContent)}`, '_blank');
    });


    // inputのダブルクリックイベント
    input.addEventListener('dblclick', () => {
        hideThumbnailPosts = !hideThumbnailPosts;
        if (hideThumbnailPosts) {
            const filteredPosts = allPosts.filter(post =>
                !(post.content.startsWith('http://') || post.content.startsWith('https://'))
            );
            renderPosts(filteredPosts);
        } else {
            renderPosts(allPosts);
        }
    });

    // postsList のクリックイベントハンドラを修正
    postsList.addEventListener('click', async (e) => {
        if (e.target.closest('a')) return;
        const postElement = e.target.closest('.post');
        if (!postElement) return;
        if (e.target.tagName === 'A') return;
        const postId = postElement.getAttribute('data-id');
        if (!postId) return;
        const currentPost = allPosts.find(post => post.id == postId);
        if (!currentPost) return;

        // 検索モードの場合
        if (isSearchMode) {
            // 絞り込みを解除して全件表示
            renderPosts(allPosts);
            isSearchMode = false;
            // 該当投稿にスクロール
            const allPostElements = document.querySelectorAll('.post');
            const targetElement = Array.from(allPostElements).find(el => el.getAttribute('data-id') == postId);
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // ハイライトを一時的に適用（視認性向上）
                targetElement.classList.add('highlight');
                setTimeout(() => {
                    targetElement.classList.remove('highlight');
                }, 2000);
            }
            return;
        }

        // 従来のハイライトトグル・発声・クリップボードコピー
        const isHighlighted = currentPost.is_highlight;
        const willBeHighlighted = !isHighlighted;
        if (willBeHighlighted) {
            const utterance = new SpeechSynthesisUtterance(currentPost.content);
            window.speechSynthesis.speak(utterance);
        }
        applyHighlightColor(postElement, willBeHighlighted);
        try {
            await navigator.clipboard.writeText(currentPost.content);
        } catch (err) {
            console.error('Failed to copy:', err);
        }
        try {
            const response = await fetch('/highlight', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: postId, is_highlight: willBeHighlighted }),
            });
            if (response.ok) {
                currentPost.is_highlight = willBeHighlighted;
            } else {
                applyHighlightColor(postElement, isHighlighted);
                alert('ハイライトの更新に失敗しました。');
            }
        } catch (error) {
            console.error('Error updating highlight:', error);
            applyHighlightColor(postElement, isHighlighted);
            alert('ハイライトの更新に失敗しました。');
        }
    });


    let showOnlyHighlighted = false;
    input.addEventListener('click', () => {
        if (input.value.trim() === '') {
            showOnlyHighlighted = !showOnlyHighlighted;
            if (showOnlyHighlighted) {
                const highlightedPosts = allPosts.filter(post => post.is_highlight);
                renderPosts(highlightedPosts);
            } else {
                renderPosts(allPosts);
            }
        }
    });

    if (postParam) {
        input.value = postParam;
        const event = new KeyboardEvent('keydown', { key: 'Enter' });
        input.dispatchEvent(event);
    }

    if (!postOnlyMode) fetchAllPosts();
    input.focus();
    // ページにフォーカスが戻った時に最新ポストを取得
    document.addEventListener('visibilitychange', async () => {
        if (document.visibilityState === 'visible' && !postOnlyMode) {
            await fetchAllPosts();
        }
    });

</script>

</body>

げ id="qrcode"></div>
</div>
<div id="searchHistory">
    <h4>検索履歴</h4>
    <ul id="historyList"></ul>
</div>
</div>
</div>

<script>
    const lightPastelColors = [
        '#FFD1DC', '#FFE4B5', '#E6E6FA', '#B5EAD7', '#FFB6C1',
        '#E0FFFF', '#F0E68C', '#D8BFD8', '#FFDAB9', '#E0F6FF',
        '#F0F8FF', '#FAEBD7', '#FFE4E1', '#D3D3D3', '#F5F5DC',
        '#FFEBCD', '#F5DEB3', '#FFFACD', '#E6E6FA', '#F0FFF0'
    ];
    const darkPastelColors = [
        '#4A2D3A', '#4A412A', '#3A3A4A', '#2D4A3A', '#4A2D2D',
        '#2D3A4A', '#4A3A2D', '#3A2D4A', '#2D3A3A', '#3A3A2D',
        '#4A3A4A', '#2D2D4A', '#3A2D3A', '#413A2D', '#412D3A',
        '#4A2D41', '#2D414A', '#413A4A', '#3A412D', '#412D3A'
    ];

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function applyRandomPastelColor() {
        const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        let pastelColors = isDarkMode ? [...darkPastelColors] : [...lightPastelColors];
        pastelColors = shuffleArray(pastelColors);
        const randomColor = pastelColors[0];
        document.documentElement.style.setProperty('--bg-color', randomColor);
        const lastUpdate = localStorage.getItem('lastUpdate');
        if (lastUpdate) {
            const hoursPassed = (Date.now() - lastUpdate) / (1000 * 60 * 60);
            const sepiaValue = Math.min(hoursPassed * 0.02, 0.3);
            document.documentElement.style.setProperty('--sepia-filter', `sepia(${sepiaValue})`);
        } else {
            localStorage.setItem('lastUpdate', Date.now());
        }
    }

    window.addEventListener('load', applyRandomPastelColor);

    const urlParams = new URLSearchParams(window.location.search);
    const postOnlyMode = urlParams.get('postonly') === 'yes';
    const postParam = urlParams.get('p');

    const input = document.getElementById('post-input');
    const postsList = document.getElementById('posts');
    const modal = document.getElementById('contextModal');
    const urlContent = document.getElementById('urlContent');
    const searchHistory = document.getElementById('searchHistory');
    const historyList = document.getElementById('historyList');
    const shareUrlElement = document.getElementById('shareUrl');
    const showUrlBtn = document.getElementById('showUrlBtn');
    const downloadCsvBtn = document.getElementById('downloadCsvBtn');
    const statsBtn = document.getElementById('statsBtn');
    const showHistoryBtn = document.getElementById('showHistoryBtn');
    const sendTodayPostsBtn = document.getElementById('sendTodayPostsBtn');
    const postCountElement = document.getElementById('post-count');

    let allPosts = [];
    let isPosting = false;
    let isSearchMode = false;
    let hideThumbnailPosts = false;



    // トークン取得
    function getTokenFromCookie() {
        const urlToken = urlParams.get('token');
        if (urlToken) return urlToken;
        const cookies = document.cookie.split(';').map(cookie => cookie.trim());
        const tokenCookie = cookies.find(cookie => cookie.startsWith('token='));
        return tokenCookie ? tokenCookie.split('=')[1] : '';
    }

    function getThumbnailUrl(pageUrl) {
        const vid = extractYouTubeVideoId(pageUrl);
        if (vid) {
            return `https://i.ytimg.com/vi/${encodeURIComponent(vid)}/maxresdefault.jpg`;
        }
        return `https://rdl.ink/render/${encodeURIComponent(pageUrl)}?mode=fillmax&fill=solid&format=webp&width=254&ar=16:9&dpr=2.25`;
    }
    // YouTube動画IDを抽出
    function extractYouTubeVideoId(rawUrl) {
        try {
            const u = new URL(rawUrl);
            // watch?v= に対応
            if ((u.hostname === 'www.youtube.com' || u.hostname === 'youtube.com' || u.hostname.endsWith('.youtube.com')) && u.pathname === '/watch') {
                return u.searchParams.get('v');
            }
            // youtu.be に対応
            if (u.hostname === 'youtu.be') {
                const seg = u.pathname.replace(/^\//, '');
                return seg || null;
            }
            // embed に対応
            if ((u.hostname === 'www.youtube.com' || u.hostname === 'youtube.com' || u.hostname.endsWith('.youtube.com')) && u.pathname.startsWith('/embed/')) {
                const seg = u.pathname.split('/embed/')[1];
                return seg || null;
            }
            return null;
        } catch (_) {
            return null;
        }
    }

    // 投稿一覧取得
    async function fetchAllPosts() {
        if (postOnlyMode) return;
        const response = await fetch('/search?q=');
        allPosts = await response.json();
        renderPosts(allPosts);
        updatePostCount();
    }

    function linkifyHashtags(text) {
        return text.replace(/#(\w+)/g, '<span class="post-hashtag" onclick="inputHashtag(\'$1\')">#$1</span>');
    }
    // ハッシュタグをinputに代入してfilterPostsを実行
    function inputHashtag(hashtag) {
        input.value = '#' + hashtag;
        filterPosts('#' + hashtag);
    }

    function renderPosts(posts) {
        postsList.innerHTML = posts.map(post => {
            // 1. まずURLをサムネイルリンクに置換
            let content = post.content;
            content = content.replace(/((https?:\/\/[^\s]+))/g, (match, url) => {
                return `<a href="${url}" target="_blank" class="post-thumbnail-link" data-encoded-url="${url}">
                <img src="${getThumbnailUrl(url)}" alt="サムネイル" class="post-thumbnail" onerror="this.style.display='none'; this.parentNode.innerHTML='${url}';">
            </a>`;
            });
            // 2. ハッシュタグをリンクに置換
            content = linkifyHashtags(content);
            return `
            <li class="post ${post.is_highlight ? 'highlight' : ''}"
                data-time="${new Date(post.created_at).toLocaleString()}"
                data-id="${post.id}"
                style="${post.is_highlight ? `background-color: ${post.highlight_color || ''};` : ''}">
                ${content}
            </li>
        `;
        }).join('');
        document.querySelectorAll('.post.highlight').forEach(el => {
            applyHighlightColor(el, true);
        });
    }


    // 投稿数更新
    function updatePostCount() {
        postCountElement.textContent = `${allPosts.length} Posts`;
    }

    // 投稿フィルタリング
    function filterPosts(query) {
        if (postOnlyMode || !query) {
            if (!postOnlyMode) renderPosts(allPosts);
            isSearchMode = false;
            return;
        }

        function normalize(s) {
            return s.replace(/[ァ-ヴ]/g, m => String.fromCharCode(m.charCodeAt(0) - 0x60))
                .replace(/[Ａ-Ｚａ-ｚ０-９]/g, m => String.fromCharCode(m.charCodeAt(0) - 0xFEE0))
                .toLowerCase()
                .trim();
        }

        isSearchMode = true;
        const aliasMap = {};
        allPosts.forEach(post => {
            const eqMatch = post.content.match(/^([^[=\s]+)\s*=\s*([^=\s]+)$/);
            if (eqMatch) {
                const a = normalize(eqMatch[1]), b = normalize(eqMatch[2]);
                aliasMap[a] = b;
                aliasMap[b] = a;
            } else if (post.content.includes('=')) {
                const eqParts = post.content.split('=');
                if (eqParts.length === 2) {
                    const a = normalize(eqParts[0]), b = normalize(eqParts[1]);
                    aliasMap[a] = b;
                    aliasMap[b] = a;
                }
            }
        });

        const queries = [normalize(query)];
        if (aliasMap[queries[0]]) queries.push(aliasMap[queries[0]]);

        // エンコードされたURLも検索対象に含める
        const encodedQuery = encodeURIComponent(query);

        const filtered = allPosts.filter(post => {
            let aliasList = [post.content];
            const eqMatch = post.content.match(/^([^[=\s]+)\s*=\s*([^=\s]+)$/);
            if (eqMatch) {
                aliasList.push(eqMatch[1], eqMatch[2]);
            } else if (post.content.includes('=')) {
                const eqParts = post.content.split('=');
                if (eqParts.length === 2) aliasList.push(eqParts[0], eqParts[1]);
            }

            // URLの場合はエンコードされた文字列も検索対象に含める
            if (post.content.startsWith('http://') || post.content.startsWith('https://')) {
                const encodedContent = encodeURIComponent(post.content);
                return queries.some(q => aliasList.some(str => normalize(str).includes(q))) ||
                    encodedContent.includes(encodedQuery);
            } else {
                return queries.some(q => aliasList.some(str => normalize(str).includes(q)));
            }
        });

        renderPosts(filtered);
        saveSearchQuery(query);
    }

    // 投稿送信
    async function postContent(content) {
        await fetch('/post', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content }),
        });
        history.replaceState({}, '', window.location.pathname);
        if (!postOnlyMode) await fetchAllPosts();
        // 投稿後にURLパラメータを消す
    }


    // URL表示
    function showUrlWithToken() {
        const token = getTokenFromCookie();
        const url = `${window.location.origin}${postOnlyMode ? '?postonly=yes&' : '?'}token=${token}`;
        shareUrlElement.href = url;
        shareUrlElement.textContent = url;
        document.getElementById('qrcode').innerHTML =
            `<img src="https://idy.vercel.app/q/${encodeURIComponent(url)}" alt="QRコード">`;
        urlContent.style.display = 'block';
        searchHistory.style.display = 'none';
    }

    // CSVダウンロード
    function downloadCsv() {
        if (postOnlyMode) {
            alert('投稿専用モードではデータをダウンロードできません。');
            return;
        }
        const csvHeader = ['タイムスタンプ,メモ内容'];
        const csvRows = allPosts.map(post =>
            `"${new Date(post.created_at).toLocaleString()}",${post.content.replace(/\"/g, '""')}"`
        );
        const csvContent = [...csvHeader, ...csvRows].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'microblog_export.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // 統計ページへ
    function goToStats() {
        window.location.href = '/stats';
    }

    // 今日の投稿を送信
    function sendTodayPosts() {
        const now = new Date();
        const jstOffset = 9 * 60 * 60 * 1000;
        const jstDate = new Date(now.getTime() + jstOffset).toISOString().split('T')[0];
        const todayPosts = allPosts.filter(post => {
            const postDate = new Date(post.created_at);
            const postJstDate = new Date(postDate.getTime() + jstOffset).toISOString().split('T')[0];
            return postJstDate === jstDate;
        });
        if (todayPosts.length === 0) return;
        const message = todayPosts.map(post =>
            `${new Date(post.created_at).toLocaleTimeString()}：${post.content}`
        ).join('\n');
        const prompt = `これはランダムなつぶやきです。MECEに整理してください。\n\n${message}`;
        const encodedMessage = encodeURIComponent(prompt);
        const url = `https://chat.mistral.ai/chat?q=${encodedMessage}`;
        window.open(url, '_blank');
    }

    // 検索履歴保存
    function saveSearchQuery(query) {
        const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        if (!history.includes(query)) {
            history.unshift(query);
            localStorage.setItem('searchHistory', JSON.stringify(history.slice(0, 10)));
            updateHistoryDisplay();
        }
    }

    // 検索履歴表示更新
    function updateHistoryDisplay() {
        const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        historyList.innerHTML = history.map(q =>
            `<li onclick="filterPosts('${q}')">${q}</li>`
        ).join('');
    }

    // ハイライト色適用
    function applyHighlightColor(postElement, isHighlighted) {
        if (isHighlighted) {
            const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const pastelColors = isDarkMode ? darkPastelColors : lightPastelColors;
            const shuffledColors = shuffleArray([...pastelColors]);
            const randomColor = shuffledColors[0];
            postElement.style.backgroundColor = randomColor;
            postElement.classList.add('highlight');
        } else {
            postElement.style.backgroundColor = '';
            postElement.classList.remove('highlight');
        }
    }

    // イベントリスナー
    document.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        urlContent.style.display = 'none';
        searchHistory.style.display = 'none';
        modal.classList.add('show');
        modal.style.display = 'block';
    });

    window.onclick = (event) => {
        if (event.target === modal) modal.style.display = 'none';
    };

    showUrlBtn.addEventListener('click', showUrlWithToken);
    downloadCsvBtn.addEventListener('click', downloadCsv);
    statsBtn.addEventListener('click', goToStats);
    showHistoryBtn.addEventListener('click', () => {
        searchHistory.style.display = 'block';
        urlContent.style.display = 'none';
        updateHistoryDisplay();
    });
    sendTodayPostsBtn.addEventListener('click', sendTodayPosts);

    input.addEventListener('input', (e) => filterPosts(e.target.value));
    input.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter' && input.value.trim() && !isPosting) {
            const content = input.value.trim();
            input.value = '';
            input.disabled = true;
            isPosting = true;
            const dummyPost = {
                content: content,
                created_at: new Date().toISOString(),
                id: Date.now(),
                is_highlight: false
            };
            allPosts = [dummyPost, ...allPosts];
            renderPosts(allPosts);
            input.focus(); // ここでフォーカスを戻す
            try {
                await postContent(content);
            } finally {
                input.disabled = false;
                isPosting = false;
                input.focus(); // 非同期処理完了後にもフォーカスを戻す
            }
        }
    });

    // 投稿のダブルクリックイベント
    postsList.addEventListener('dblclick', (e) => {
        if (e.target.closest('a')) return;
        const postElement = e.target.closest('.post');
        if (!postElement) return;
        const postContent = postElement.textContent.trim();
        // Xの投稿画面を開く
        window.open(`https://x.com/intent/post?text=${encodeURIComponent(postContent)}`, '_blank');
    });


    // inputのダブルクリックイベント
    input.addEventListener('dblclick', () => {
        hideThumbnailPosts = !hideThumbnailPosts;
        if (hideThumbnailPosts) {
            const filteredPosts = allPosts.filter(post =>
                !(post.content.startsWith('http://') || post.content.startsWith('https://'))
            );
            renderPosts(filteredPosts);
        } else {
            renderPosts(allPosts);
        }
    });

    // postsList のクリックイベントハンドラを修正
    postsList.addEventListener('click', async (e) => {
        if (e.target.closest('a')) return;
        const postElement = e.target.closest('.post');
        if (!postElement) return;
        if (e.target.tagName === 'A') return;
        const postId = postElement.getAttribute('data-id');
        if (!postId) return;
        const currentPost = allPosts.find(post => post.id == postId);
        if (!currentPost) return;

        // 検索モードの場合
        if (isSearchMode) {
            // 絞り込みを解除して全件表示
            renderPosts(allPosts);
            isSearchMode = false;
            // 該当投稿にスクロール
            const allPostElements = document.querySelectorAll('.post');
            const targetElement = Array.from(allPostElements).find(el => el.getAttribute('data-id') == postId);
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // ハイライトを一時的に適用（視認性向上）
                targetElement.classList.add('highlight');
                setTimeout(() => {
                    targetElement.classList.remove('highlight');
                }, 2000);
            }
            return;
        }

        // 従来のハイライトトグル・発声・クリップボードコピー
        const isHighlighted = currentPost.is_highlight;
        const willBeHighlighted = !isHighlighted;
        if (willBeHighlighted) {
            const utterance = new SpeechSynthesisUtterance(currentPost.content);
            window.speechSynthesis.speak(utterance);
        }
        applyHighlightColor(postElement, willBeHighlighted);
        try {
            await navigator.clipboard.writeText(currentPost.content);
        } catch (err) {
            console.error('Failed to copy:', err);
        }
        try {
            const response = await fetch('/highlight', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: postId, is_highlight: willBeHighlighted }),
            });
            if (response.ok) {
                currentPost.is_highlight = willBeHighlighted;
            } else {
                applyHighlightColor(postElement, isHighlighted);
                alert('ハイライトの更新に失敗しました。');
            }
        } catch (error) {
            console.error('Error updating highlight:', error);
            applyHighlightColor(postElement, isHighlighted);
            alert('ハイライトの更新に失敗しました。');
        }
    });


    let showOnlyHighlighted = false;
    input.addEventListener('click', () => {
        if (input.value.trim() === '') {
            showOnlyHighlighted = !showOnlyHighlighted;
            if (showOnlyHighlighted) {
                const highlightedPosts = allPosts.filter(post => post.is_highlight);
                renderPosts(highlightedPosts);
            } else {
                renderPosts(allPosts);
            }
        }
    });

    if (postParam) {
        input.value = postParam;
        const event = new KeyboardEvent('keydown', { key: 'Enter' });
        input.dispatchEvent(event);
    }

    if (!postOnlyMode) fetchAllPosts();
    input.focus();
    // ページにフォーカスが戻った時に最新ポストを取得
    document.addEventListener('visibilitychange', async () => {
        if (document.visibilityState === 'visible' && !postOnlyMode) {
            await fetchAllPosts();
        }
    });

</script>

</body>

id="qrcode"></div>
</div>
<div id="searchHistory">
    <h4>検索履歴</h4>
    <ul id="historyList"></ul>
</div>
</div>
</div>

<script>
    const lightPastelColors = [
        '#FFD1DC', '#FFE4B5', '#E6E6FA', '#B5EAD7', '#FFB6C1',
        '#E0FFFF', '#F0E68C', '#D8BFD8', '#FFDAB9', '#E0F6FF',
        '#F0F8FF', '#FAEBD7', '#FFE4E1', '#D3D3D3', '#F5F5DC',
        '#FFEBCD', '#F5DEB3', '#FFFACD', '#E6E6FA', '#F0FFF0'
    ];
    const darkPastelColors = [
        '#4A2D3A', '#4A412A', '#3A3A4A', '#2D4A3A', '#4A2D2D',
        '#2D3A4A', '#4A3A2D', '#3A2D4A', '#2D3A3A', '#3A3A2D',
        '#4A3A4A', '#2D2D4A', '#3A2D3A', '#413A2D', '#412D3A',
        '#4A2D41', '#2D414A', '#413A4A', '#3A412D', '#412D3A'
    ];

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function applyRandomPastelColor() {
        const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        let pastelColors = isDarkMode ? [...darkPastelColors] : [...lightPastelColors];
        pastelColors = shuffleArray(pastelColors);
        const randomColor = pastelColors[0];
        document.documentElement.style.setProperty('--bg-color', randomColor);
        const lastUpdate = localStorage.getItem('lastUpdate');
        if (lastUpdate) {
            const hoursPassed = (Date.now() - lastUpdate) / (1000 * 60 * 60);
            const sepiaValue = Math.min(hoursPassed * 0.02, 0.3);
            document.documentElement.style.setProperty('--sepia-filter', `sepia(${sepiaValue})`);
        } else {
            localStorage.setItem('lastUpdate', Date.now());
        }
    }

    window.addEventListener('load', applyRandomPastelColor);

    const urlParams = new URLSearchParams(window.location.search);
    const postOnlyMode = urlParams.get('postonly') === 'yes';
    const postParam = urlParams.get('p');

    const input = document.getElementById('post-input');
    const postsList = document.getElementById('posts');
    const modal = document.getElementById('contextModal');
    const urlContent = document.getElementById('urlContent');
    const searchHistory = document.getElementById('searchHistory');
    const historyList = document.getElementById('historyList');
    const shareUrlElement = document.getElementById('shareUrl');
    const showUrlBtn = document.getElementById('showUrlBtn');
    const downloadCsvBtn = document.getElementById('downloadCsvBtn');
    const statsBtn = document.getElementById('statsBtn');
    const showHistoryBtn = document.getElementById('showHistoryBtn');
    const sendTodayPostsBtn = document.getElementById('sendTodayPostsBtn');
    const postCountElement = document.getElementById('post-count');

    let allPosts = [];
    let isPosting = false;
    let isSearchMode = false;
    let hideThumbnailPosts = false;



    // トークン取得
    function getTokenFromCookie() {
        const urlToken = urlParams.get('token');
        if (urlToken) return urlToken;
        const cookies = document.cookie.split(';').map(cookie => cookie.trim());
        const tokenCookie = cookies.find(cookie => cookie.startsWith('token='));
        return tokenCookie ? tokenCookie.split('=')[1] : '';
    }

    function getThumbnailUrl(pageUrl) {
        const vid = extractYouTubeVideoId(pageUrl);
        if (vid) {
            return `https://i.ytimg.com/vi/${encodeURIComponent(vid)}/maxresdefault.jpg`;
        }
        return `https://rdl.ink/render/${encodeURIComponent(pageUrl)}?mode=fillmax&fill=solid&format=webp&width=254&ar=16:9&dpr=2.25`;
    }
    // YouTube動画IDを抽出
    function extractYouTubeVideoId(rawUrl) {
        try {
            const u = new URL(rawUrl);
            // watch?v= に対応
            if ((u.hostname === 'www.youtube.com' || u.hostname === 'youtube.com' || u.hostname.endsWith('.youtube.com')) && u.pathname === '/watch') {
                return u.searchParams.get('v');
            }
            // youtu.be に対応
            if (u.hostname === 'youtu.be') {
                const seg = u.pathname.replace(/^\//, '');
                return seg || null;
            }
            // embed に対応
            if ((u.hostname === 'www.youtube.com' || u.hostname === 'youtube.com' || u.hostname.endsWith('.youtube.com')) && u.pathname.startsWith('/embed/')) {
                const seg = u.pathname.split('/embed/')[1];
                return seg || null;
            }
            return null;
        } catch (_) {
            return null;
        }
    }

    // 投稿一覧取得
    async function fetchAllPosts() {
        if (postOnlyMode) return;
        const response = await fetch('/search?q=');
        allPosts = await response.json();
        renderPosts(allPosts);
        updatePostCount();
    }

    function linkifyHashtags(text) {
        return text.replace(/#(\w+)/g, '<span class="post-hashtag" onclick="inputHashtag(\'$1\')">#$1</span>');
    }
    // ハッシュタグをinputに代入してfilterPostsを実行
    function inputHashtag(hashtag) {
        input.value = '#' + hashtag;
        filterPosts('#' + hashtag);
    }

    function renderPosts(posts) {
        postsList.innerHTML = posts.map(post => {
            // 1. まずURLをサムネイルリンクに置換
            let content = post.content;
            content = content.replace(/((https?:\/\/[^\s]+))/g, (match, url) => {
                return `<a href="${url}" target="_blank" class="post-thumbnail-link" data-encoded-url="${url}">
                <img src="${getThumbnailUrl(url)}" alt="サムネイル" class="post-thumbnail" onerror="this.style.display='none'; this.parentNode.innerHTML='${url}';">
            </a>`;
            });
            // 2. ハッシュタグをリンクに置換
            content = linkifyHashtags(content);
            return `
            <li class="post ${post.is_highlight ? 'highlight' : ''}"
                data-time="${new Date(post.created_at).toLocaleString()}"
                data-id="${post.id}"
                style="${post.is_highlight ? `background-color: ${post.highlight_color || ''};` : ''}">
                ${content}
            </li>
        `;
        }).join('');
        document.querySelectorAll('.post.highlight').forEach(el => {
            applyHighlightColor(el, true);
        });
    }


    // 投稿数更新
    function updatePostCount() {
        postCountElement.textContent = `${allPosts.length} Posts`;
    }

    // 投稿フィルタリング
    function filterPosts(query) {
        if (postOnlyMode || !query) {
            if (!postOnlyMode) renderPosts(allPosts);
            isSearchMode = false;
            return;
        }

        function normalize(s) {
            return s.replace(/[ァ-ヴ]/g, m => String.fromCharCode(m.charCodeAt(0) - 0x60))
                .replace(/[Ａ-Ｚａ-ｚ０-９]/g, m => String.fromCharCode(m.charCodeAt(0) - 0xFEE0))
                .toLowerCase()
                .trim();
        }

        isSearchMode = true;
        const aliasMap = {};
        allPosts.forEach(post => {
            const eqMatch = post.content.match(/^([^[=\s]+)\s*=\s*([^=\s]+)$/);
            if (eqMatch) {
                const a = normalize(eqMatch[1]), b = normalize(eqMatch[2]);
                aliasMap[a] = b;
                aliasMap[b] = a;
            } else if (post.content.includes('=')) {
                const eqParts = post.content.split('=');
                if (eqParts.length === 2) {
                    const a = normalize(eqParts[0]), b = normalize(eqParts[1]);
                    aliasMap[a] = b;
                    aliasMap[b] = a;
                }
            }
        });

        const queries = [normalize(query)];
        if (aliasMap[queries[0]]) queries.push(aliasMap[queries[0]]);

        // エンコードされたURLも検索対象に含める
        const encodedQuery = encodeURIComponent(query);

        const filtered = allPosts.filter(post => {
            let aliasList = [post.content];
            const eqMatch = post.content.match(/^([^[=\s]+)\s*=\s*([^=\s]+)$/);
            if (eqMatch) {
                aliasList.push(eqMatch[1], eqMatch[2]);
            } else if (post.content.includes('=')) {
                const eqParts = post.content.split('=');
                if (eqParts.length === 2) aliasList.push(eqParts[0], eqParts[1]);
            }

            // URLの場合はエンコードされた文字列も検索対象に含める
            if (post.content.startsWith('http://') || post.content.startsWith('https://')) {
                const encodedContent = encodeURIComponent(post.content);
                return queries.some(q => aliasList.some(str => normalize(str).includes(q))) ||
                    encodedContent.includes(encodedQuery);
            } else {
                return queries.some(q => aliasList.some(str => normalize(str).includes(q)));
            }
        });

        renderPosts(filtered);
        saveSearchQuery(query);
    }

    // 投稿送信
    async function postContent(content) {
        await fetch('/post', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content }),
        });
        history.replaceState({}, '', window.location.pathname);
        if (!postOnlyMode) await fetchAllPosts();
        // 投稿後にURLパラメータを消す
    }


    // URL表示
    function showUrlWithToken() {
        const token = getTokenFromCookie();
        const url = `${window.location.origin}${postOnlyMode ? '?postonly=yes&' : '?'}token=${token}`;
        shareUrlElement.href = url;
        shareUrlElement.textContent = url;
        document.getElementById('qrcode').innerHTML =
            `<img src="https://idy.vercel.app/q/${encodeURIComponent(url)}" alt="QRコード">`;
        urlContent.style.display = 'block';
        searchHistory.style.display = 'none';
    }

    // CSVダウンロード
    function downloadCsv() {
        if (postOnlyMode) {
            alert('投稿専用モードではデータをダウンロードできません。');
            return;
        }
        const csvHeader = ['タイムスタンプ,メモ内容'];
        const csvRows = allPosts.map(post =>
            `"${new Date(post.created_at).toLocaleString()}",${post.content.replace(/\"/g, '""')}"`
        );
        const csvContent = [...csvHeader, ...csvRows].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'microblog_export.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // 統計ページへ
    function goToStats() {
        window.location.href = '/stats';
    }

    // 今日の投稿を送信
    function sendTodayPosts() {
        const now = new Date();
        const jstOffset = 9 * 60 * 60 * 1000;
        const jstDate = new Date(now.getTime() + jstOffset).toISOString().split('T')[0];
        const todayPosts = allPosts.filter(post => {
            const postDate = new Date(post.created_at);
            const postJstDate = new Date(postDate.getTime() + jstOffset).toISOString().split('T')[0];
            return postJstDate === jstDate;
        });
        if (todayPosts.length === 0) return;
        const message = todayPosts.map(post =>
            `${new Date(post.created_at).toLocaleTimeString()}：${post.content}`
        ).join('\n');
        const prompt = `これはランダムなつぶやきです。MECEに整理してください。\n\n${message}`;
        const encodedMessage = encodeURIComponent(prompt);
        const url = `https://chat.mistral.ai/chat?q=${encodedMessage}`;
        window.open(url, '_blank');
    }

    // 検索履歴保存
    function saveSearchQuery(query) {
        const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        if (!history.includes(query)) {
            history.unshift(query);
            localStorage.setItem('searchHistory', JSON.stringify(history.slice(0, 10)));
            updateHistoryDisplay();
        }
    }

    // 検索履歴表示更新
    function updateHistoryDisplay() {
        const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        historyList.innerHTML = history.map(q =>
            `<li onclick="filterPosts('${q}')">${q}</li>`
        ).join('');
    }

    // ハイライト色適用
    function applyHighlightColor(postElement, isHighlighted) {
        if (isHighlighted) {
            const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const pastelColors = isDarkMode ? darkPastelColors : lightPastelColors;
            const shuffledColors = shuffleArray([...pastelColors]);
            const randomColor = shuffledColors[0];
            postElement.style.backgroundColor = randomColor;
            postElement.classList.add('highlight');
        } else {
            postElement.style.backgroundColor = '';
            postElement.classList.remove('highlight');
        }
    }

    // イベントリスナー
    document.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        urlContent.style.display = 'none';
        searchHistory.style.display = 'none';
        modal.classList.add('show');
        modal.style.display = 'block';
    });

    window.onclick = (event) => {
        if (event.target === modal) modal.style.display = 'none';
    };

    showUrlBtn.addEventListener('click', showUrlWithToken);
    downloadCsvBtn.addEventListener('click', downloadCsv);
    statsBtn.addEventListener('click', goToStats);
    showHistoryBtn.addEventListener('click', () => {
        searchHistory.style.display = 'block';
        urlContent.style.display = 'none';
        updateHistoryDisplay();
    });
    sendTodayPostsBtn.addEventListener('click', sendTodayPosts);

    input.addEventListener('input', (e) => filterPosts(e.target.value));
    input.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter' && input.value.trim() && !isPosting) {
            const content = input.value.trim();
            input.value = '';
            input.disabled = true;
            isPosting = true;
            const dummyPost = {
                content: content,
                created_at: new Date().toISOString(),
                id: Date.now(),
                is_highlight: false
            };
            allPosts = [dummyPost, ...allPosts];
            renderPosts(allPosts);
            input.focus(); // ここでフォーカスを戻す
            try {
                await postContent(content);
            } finally {
                input.disabled = false;
                isPosting = false;
                input.focus(); // 非同期処理完了後にもフォーカスを戻す
            }
        }
    });

    // 投稿のダブルクリックイベント
    postsList.addEventListener('dblclick', (e) => {
        if (e.target.closest('a')) return;
        const postElement = e.target.closest('.post');
        if (!postElement) return;
        const postContent = postElement.textContent.trim();
        // Xの投稿画面を開く
        window.open(`https://x.com/intent/post?text=${encodeURIComponent(postContent)}`, '_blank');
    });


    // inputのダブルクリックイベント
    input.addEventListener('dblclick', () => {
        hideThumbnailPosts = !hideThumbnailPosts;
        if (hideThumbnailPosts) {
            const filteredPosts = allPosts.filter(post =>
                !(post.content.startsWith('http://') || post.content.startsWith('https://'))
            );
            renderPosts(filteredPosts);
        } else {
            renderPosts(allPosts);
        }
    });

    // postsList のクリックイベントハンドラを修正
    postsList.addEventListener('click', async (e) => {
        if (e.target.closest('a')) return;
        const postElement = e.target.closest('.post');
        if (!postElement) return;
        if (e.target.tagName === 'A') return;
        const postId = postElement.getAttribute('data-id');
        if (!postId) return;
        const currentPost = allPosts.find(post => post.id == postId);
        if (!currentPost) return;

        // 検索モードの場合
        if (isSearchMode) {
            // 絞り込みを解除して全件表示
            renderPosts(allPosts);
            isSearchMode = false;
            // 該当投稿にスクロール
            const allPostElements = document.querySelectorAll('.post');
            const targetElement = Array.from(allPostElements).find(el => el.getAttribute('data-id') == postId);
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // ハイライトを一時的に適用（視認性向上）
                targetElement.classList.add('highlight');
                setTimeout(() => {
                    targetElement.classList.remove('highlight');
                }, 2000);
            }
            return;
        }

        // 従来のハイライトトグル・発声・クリップボードコピー
        const isHighlighted = currentPost.is_highlight;
        const willBeHighlighted = !isHighlighted;
        if (willBeHighlighted) {
            const utterance = new SpeechSynthesisUtterance(currentPost.content);
            window.speechSynthesis.speak(utterance);
        }
        applyHighlightColor(postElement, willBeHighlighted);
        try {
            await navigator.clipboard.writeText(currentPost.content);
        } catch (err) {
            console.error('Failed to copy:', err);
        }
        try {
            const response = await fetch('/highlight', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: postId, is_highlight: willBeHighlighted }),
            });
            if (response.ok) {
                currentPost.is_highlight = willBeHighlighted;
            } else {
                applyHighlightColor(postElement, isHighlighted);
                alert('ハイライトの更新に失敗しました。');
            }
        } catch (error) {
            console.error('Error updating highlight:', error);
            applyHighlightColor(postElement, isHighlighted);
            alert('ハイライトの更新に失敗しました。');
        }
    });


    let showOnlyHighlighted = false;
    input.addEventListener('click', () => {
        if (input.value.trim() === '') {
            showOnlyHighlighted = !showOnlyHighlighted;
            if (showOnlyHighlighted) {
                const highlightedPosts = allPosts.filter(post => post.is_highlight);
                renderPosts(highlightedPosts);
            } else {
                renderPosts(allPosts);
            }
        }
    });

    if (postParam) {
        input.value = postParam;
        const event = new KeyboardEvent('keydown', { key: 'Enter' });
        input.dispatchEvent(event);
    }

    if (!postOnlyMode) fetchAllPosts();
    input.focus();
    // ページにフォーカスが戻った時に最新ポストを取得
    document.addEventListener('visibilitychange', async () => {
        if (document.visibilityState === 'visible' && !postOnlyMode) {
            await fetchAllPosts();
        }
    });

</script>

</body>

id="qrcode"></div>
</div>
<div id="searchHistory">
    <h4>検索履歴</h4>
    <ul id="historyList"></ul>
</div>
</div>
</div>

<script>
    const lightPastelColors = [
        '#FFD1DC', '#FFE4B5', '#E6E6FA', '#B5EAD7', '#FFB6C1',
        '#E0FFFF', '#F0E68C', '#D8BFD8', '#FFDAB9', '#E0F6FF',
        '#F0F8FF', '#FAEBD7', '#FFE4E1', '#D3D3D3', '#F5F5DC',
        '#FFEBCD', '#F5DEB3', '#FFFACD', '#E6E6FA', '#F0FFF0'
    ];
    const darkPastelColors = [
        '#4A2D3A', '#4A412A', '#3A3A4A', '#2D4A3A', '#4A2D2D',
        '#2D3A4A', '#4A3A2D', '#3A2D4A', '#2D3A3A', '#3A3A2D',
        '#4A3A4A', '#2D2D4A', '#3A2D3A', '#413A2D', '#412D3A',
        '#4A2D41', '#2D414A', '#413A4A', '#3A412D', '#412D3A'
    ];

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function applyRandomPastelColor() {
        const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        let pastelColors = isDarkMode ? [...darkPastelColors] : [...lightPastelColors];
        pastelColors = shuffleArray(pastelColors);
        const randomColor = pastelColors[0];
        document.documentElement.style.setProperty('--bg-color', randomColor);
        const lastUpdate = localStorage.getItem('lastUpdate');
        if (lastUpdate) {
            const hoursPassed = (Date.now() - lastUpdate) / (1000 * 60 * 60);
            const sepiaValue = Math.min(hoursPassed * 0.02, 0.3);
            document.documentElement.style.setProperty('--sepia-filter', `sepia(${sepiaValue})`);
        } else {
            localStorage.setItem('lastUpdate', Date.now());
        }
    }

    window.addEventListener('load', applyRandomPastelColor);

    const urlParams = new URLSearchParams(window.location.search);
    const postOnlyMode = urlParams.get('postonly') === 'yes';
    const postParam = urlParams.get('p');

    const input = document.getElementById('post-input');
    const postsList = document.getElementById('posts');
    const modal = document.getElementById('contextModal');
    const urlContent = document.getElementById('urlContent');
    const searchHistory = document.getElementById('searchHistory');
    const historyList = document.getElementById('historyList');
    const shareUrlElement = document.getElementById('shareUrl');
    const showUrlBtn = document.getElementById('showUrlBtn');
    const downloadCsvBtn = document.getElementById('downloadCsvBtn');
    const statsBtn = document.getElementById('statsBtn');
    const showHistoryBtn = document.getElementById('showHistoryBtn');
    const sendTodayPostsBtn = document.getElementById('sendTodayPostsBtn');
    const postCountElement = document.getElementById('post-count');

    let allPosts = [];
    let isPosting = false;
    let isSearchMode = false;
    let hideThumbnailPosts = false;



    // トークン取得
    function getTokenFromCookie() {
        const urlToken = urlParams.get('token');
        if (urlToken) return urlToken;
        const cookies = document.cookie.split(';').map(cookie => cookie.trim());
        const tokenCookie = cookies.find(cookie => cookie.startsWith('token='));
        return tokenCookie ? tokenCookie.split('=')[1] : '';
    }

    function getThumbnailUrl(pageUrl) {
        const vid = extractYouTubeVideoId(pageUrl);
        if (vid) {
            return `https://i.ytimg.com/vi/${encodeURIComponent(vid)}/maxresdefault.jpg`;
        }
        return `https://rdl.ink/render/${encodeURIComponent(pageUrl)}?mode=fillmax&fill=solid&format=webp&width=254&ar=16:9&dpr=2.25`;
    }
    // YouTube動画IDを抽出
    function extractYouTubeVideoId(rawUrl) {
        try {
            const u = new URL(rawUrl);
            // watch?v= に対応
            if ((u.hostname === 'www.youtube.com' || u.hostname === 'youtube.com' || u.hostname.endsWith('.youtube.com')) && u.pathname === '/watch') {
                return u.searchParams.get('v');
            }
            // youtu.be に対応
            if (u.hostname === 'youtu.be') {
                const seg = u.pathname.replace(/^\//, '');
                return seg || null;
            }
            // embed に対応
            if ((u.hostname === 'www.youtube.com' || u.hostname === 'youtube.com' || u.hostname.endsWith('.youtube.com')) && u.pathname.startsWith('/embed/')) {
                const seg = u.pathname.split('/embed/')[1];
                return seg || null;
            }
            return null;
        } catch (_) {
            return null;
        }
    }

    // 投稿一覧取得
    async function fetchAllPosts() {
        if (postOnlyMode) return;
        const response = await fetch('/search?q=');
        allPosts = await response.json();
        renderPosts(allPosts);
        updatePostCount();
    }

    function linkifyHashtags(text) {
        return text.replace(/#(\w+)/g, '<span class="post-hashtag" onclick="inputHashtag(\'$1\')">#$1</span>');
    }
    // ハッシュタグをinputに代入してfilterPostsを実行
    function inputHashtag(hashtag) {
        input.value = '#' + hashtag;
        filterPosts('#' + hashtag);
    }

    function renderPosts(posts) {
        postsList.innerHTML = posts.map(post => {
            // 1. まずURLをサムネイルリンクに置換
            let content = post.content;
            content = content.replace(/((https?:\/\/[^\s]+))/g, (match, url) => {
                return rtsWith('https://'))
                );
        renderPosts(filteredPosts);
    } else {
        renderPosts(allPosts);
    }
        });

    // postsList のクリックイベントハンドラを修正
    postsList.addEventListener('click', async (e) => {
        if (e.target.closest('a')) return;
        const postElement = e.target.closest('.post');
        if (!postElement) return;
        if (e.target.tagName === 'A') return;
        const postId = postElement.getAttribute('data-id');
        if (!postId) return;
        const currentPost = allPosts.find(post => post.id == postId);
        if (!currentPost) return;

        // 検索モードの場合
        if (isSearchMode) {
            // 絞り込みを解除して全件表示
            renderPosts(allPosts);
            isSearchMode = false;
            // 該当投稿にスクロール
            const allPostElements = document.querySelectorAll('.post');
            const targetElement = Array.from(allPostElements).find(el => el.getAttribute('data-id') == postId);
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // ハイライトを一時的に適用（視認性向上）
                targetElement.classList.add('highlight');
                setTimeout(() => {
                    targetElement.classList.remove('highlight');
                }, 2000);
            }
            return;
        }

        // 従来のハイライトトグル・発声・クリップボードコピー
        const isHighlighted = currentPost.is_highlight;
        const willBeHighlighted = !isHighlighted;
        if (willBeHighlighted) {
            const utterance = new SpeechSynthesisUtterance(currentPost.content);
            window.speechSynthesis.speak(utterance);
        }
        applyHighlightColor(postElement, willBeHighlighted);
        try {
            await navigator.clipboard.writeText(currentPost.content);
        } catch (err) {
            console.error('Failed to copy:', err);
        }
        try {
            const response = await fetch('/highlight', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: postId, is_highlight: willBeHighlighted }),
            });
            if (response.ok) {
                currentPost.is_highlight = willBeHighlighted;
            } else {
                applyHighlightColor(postElement, isHighlighted);
                alert('ハイライトの更新に失敗しました。');
            }
        } catch (error) {
            console.error('Error updating highlight:', error);
            applyHighlightColor(postElement, isHighlighted);
            alert('ハイライトの更新に失敗しました。');
        }
    });


    let showOnlyHighlighted = false;
    input.addEventListener('click', () => {
        if (input.value.trim() === '') {
            showOnlyHighlighted = !showOnlyHighlighted;
            if (showOnlyHighlighted) {
                const highlightedPosts = allPosts.filter(post => post.is_highlight);
                renderPosts(highlightedPosts);
            } else {
                renderPosts(allPosts);
            }
        }
    });

    if (postParam) {
        input.value = postParam;
        const event = new KeyboardEvent('keydown', { key: 'Enter' });
        input.dispatchEvent(event);
    }

    if (!postOnlyMode) fetchAllPosts();
    input.focus();
    // ページにフォーカスが戻った時に最新ポストを取得
    document.addEventListener('visibilitychange', async () => {
        if (document.visibilityState === 'visible' && !postOnlyMode) {
            await fetchAllPosts();
        }
    });

</script>

</body>

</html>